# Inflexion â€” Briefing IA Quotidien StratÃ©gique + RAG Indexation
# ExÃ©cutÃ© 1x/jour Ã  08h UTC (aprÃ¨s fetch-data Ã  06h et article Ã  07h)
#
# Ce workflow :
# 1. Indexe les articles du jour dans le store RAG (embeddings locaux)
# 2. GÃ©nÃ¨re le briefing stratÃ©gique avec contexte historique RAG
# 3. Indexe le briefing produit dans le store RAG pour le lendemain
#
# PrÃ©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets (console.anthropic.com)
#   - PAT_TOKEN dans GitHub Secrets (pour committer)
#   - data/news.json + data de marchÃ© (gÃ©nÃ©rÃ©s par fetch-data.yml)

name: "ğŸ§  Generate Daily Briefing"

on:
  schedule:
    # Tous les jours Ã  08h UTC (2h aprÃ¨s le fetch, 1h aprÃ¨s l'article)
    - cron: '0 8 * * *'

  # ExÃ©cution manuelle depuis l'onglet Actions (utile pour tester)
  workflow_dispatch:

  # ExÃ©cuter aussi au push sur main quand le script change
  push:
    branches: [main]
    paths:
      - 'scripts/generate-daily-briefing.mjs'
      - 'scripts/rag-index.mjs'
      - 'scripts/lib/prompts.mjs'
      - 'scripts/lib/embeddings.mjs'
      - 'scripts/lib/rag-store.mjs'
      - '.github/workflows/generate-daily-briefing.yml'

# Permissions nÃ©cessaires pour committer les fichiers
permissions:
  contents: write

# Une seule exÃ©cution Ã  la fois
concurrency:
  group: "generate-daily-briefing"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "ğŸ“¥ Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "ğŸŸ¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ”„ Cache modÃ¨le transformers.js"
        uses: actions/cache@v4
        with:
          path: .cache/transformers
          key: transformers-all-MiniLM-L6-v2

      - name: "ğŸ“š RAG â€” Indexation des articles du jour"
        continue-on-error: true
        run: node scripts/rag-index.mjs --articles

      - name: "ğŸ§  GÃ©nÃ©ration du briefing stratÃ©gique (avec RAG)"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/generate-daily-briefing.mjs

      - name: "ğŸ“‹ RAG â€” Indexation du briefing produit"
        continue-on-error: true
        run: node scripts/rag-index.mjs --briefing

      - name: "ğŸ“ Commit et push"
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # Ajouter le briefing et les donnÃ©es RAG
          [ -f data/daily-briefing.json ] && git add data/daily-briefing.json || true
          [ -d data/rag ] && git add data/rag/ || true

          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "Aucun changement"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ§  Briefing IA quotidien + RAG â€” ${TIMESTAMP}

          Briefing stratÃ©gique gÃ©nÃ©rÃ© par Claude Sonnet (signaux + interconnexions + risk radar).
          Articles et briefing indexÃ©s dans le store RAG."

          git push
