# Inflexion â€” Briefing IA Quotidien StratÃ©gique + RAG Indexation
# DÃ©clenchÃ© automatiquement aprÃ¨s le succÃ¨s de fetch-data (workflow_run)
# + RÃ©-indexation RAG quand la PR article est mergÃ©e (push sur data/articles/)
#
# Ce workflow :
# 1. Indexe les articles disponibles dans le store RAG (embeddings locaux)
# 2. GÃ©nÃ¨re le briefing stratÃ©gique avec contexte historique RAG
# 3. Indexe le briefing produit dans le store RAG pour le lendemain
#
# PrÃ©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets (console.anthropic.com)
#   - PAT_TOKEN dans GitHub Secrets (pour committer)
#   - data/news.json + data de marchÃ© (gÃ©nÃ©rÃ©s par fetch-data.yml)

name: "ğŸ§  Generate Daily Briefing"

on:
  # DÃ©clenchÃ© automatiquement aprÃ¨s fetch-data (donnÃ©es marchÃ© fraÃ®ches)
  workflow_run:
    workflows: ["ğŸ“Š Fetch Market Data"]
    types: [completed]

  # ExÃ©cution manuelle depuis l'onglet Actions (utile pour tester)
  workflow_dispatch:

  # RÃ©-indexation RAG quand la PR article est mergÃ©e + quand le script change
  push:
    branches: [main]
    paths:
      - 'data/articles/**'
      - 'data/article-du-jour.json'
      - 'scripts/generate-daily-briefing.mjs'
      - 'scripts/rag-index.mjs'
      - 'scripts/lib/prompts.mjs'
      - 'scripts/lib/embeddings.mjs'
      - 'scripts/lib/rag-store.mjs'
      - '.github/workflows/generate-daily-briefing.yml'

# Permissions nÃ©cessaires pour committer les fichiers
permissions:
  contents: write

# Une seule exÃ©cution Ã  la fois
concurrency:
  group: "generate-daily-briefing"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Ne s'exÃ©cuter que si fetch-data a rÃ©ussi (ou si dÃ©clenchÃ© manuellement/push)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: "ğŸ“¥ Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "ğŸŸ¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ” VÃ©rifier la fraÃ®cheur des donnÃ©es"
        id: check-data
        run: |
          LAST_DATA_CHANGE=$(git log -1 --format="%ct" -- data/)
          NOW=$(date +%s)
          DIFF=$((NOW - LAST_DATA_CHANGE))
          if [ $DIFF -gt 1800 ]; then
            echo "data_changed=false" >> $GITHUB_OUTPUT
            echo "â­ Pas de nouvelles donnÃ©es (dernier commit data/ il y a ${DIFF}s)"
          else
            echo "data_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… DonnÃ©es fraÃ®ches dÃ©tectÃ©es (${DIFF}s)"
          fi

      - name: "ğŸ”„ Cache modÃ¨le transformers.js"
        uses: actions/cache@v4
        with:
          path: .cache/transformers
          key: transformers-all-MiniLM-L6-v2

      - name: "ğŸ“š RAG â€” Indexation des articles du jour"
        if: steps.check-data.outputs.data_changed == 'true'
        continue-on-error: true
        run: node scripts/rag-index.mjs --articles

      - name: "ğŸ§  GÃ©nÃ©ration du briefing stratÃ©gique (avec RAG)"
        if: steps.check-data.outputs.data_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/generate-daily-briefing.mjs

      - name: "ğŸ“‹ RAG â€” Indexation du briefing produit"
        if: steps.check-data.outputs.data_changed == 'true'
        continue-on-error: true
        run: node scripts/rag-index.mjs --briefing

      - name: "â­ GÃ©nÃ©ration ignorÃ©e â€” donnÃ©es inchangÃ©es"
        if: steps.check-data.outputs.data_changed != 'true'
        run: echo "Les donnÃ©es n'ont pas changÃ© depuis la derniÃ¨re exÃ©cution. Briefing ignorÃ©."

      - name: "ğŸ“ Commit et push"
        if: steps.check-data.outputs.data_changed == 'true'
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # Ajouter le briefing et les donnÃ©es RAG
          [ -f data/daily-briefing.json ] && git add data/daily-briefing.json || true
          [ -d data/rag ] && git add data/rag/ || true

          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "Aucun changement"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ§  Briefing IA quotidien + RAG â€” ${TIMESTAMP}

          Briefing stratÃ©gique gÃ©nÃ©rÃ© par Claude Sonnet (signaux + interconnexions + risk radar).
          Articles et briefing indexÃ©s dans le store RAG."

          git push
