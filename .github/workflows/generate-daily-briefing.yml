# Inflexion ‚Äî Briefing IA Quotidien Strat√©gique + RAG Indexation
# D√©clench√© automatiquement apr√®s le succ√®s de fetch-data (workflow_run)
# + R√©-indexation RAG quand la PR article est merg√©e (push sur data/articles/)
#
# Ce workflow :
# 1. Indexe les articles disponibles dans le store RAG (embeddings locaux)
# 2. G√©n√®re le briefing strat√©gique avec contexte historique RAG
# 3. Indexe le briefing produit dans le store RAG pour le lendemain
#
# Pr√©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets (console.anthropic.com)
#   - PAT_TOKEN dans GitHub Secrets (pour committer)
#   - data/news.json + data de march√© (g√©n√©r√©s par fetch-data.yml)

name: "üß† Generate Daily Briefing"

on:
  # D√©clench√© automatiquement apr√®s fetch-data (donn√©es march√© fra√Æches)
  workflow_run:
    workflows: ["üìä Fetch Market Data"]
    types: [completed]

  # Ex√©cution manuelle depuis l'onglet Actions (utile pour tester)
  workflow_dispatch:

# Permissions n√©cessaires pour committer les fichiers
permissions:
  contents: write

# Une seule ex√©cution √† la fois
concurrency:
  group: "generate-daily-briefing"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Ne s'ex√©cuter que si fetch-data a r√©ussi (ou si d√©clench√© manuellement/push)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: "üì• Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "üü¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: "üì¶ Install dependencies"
        run: npm ci

      - name: "üîç V√©rifier la fra√Æcheur des donn√©es et l'absence de doublon"
        id: check-data
        run: |
          SHOULD_RUN=true

          # 1. V√©rifier que les donn√©es sont fra√Æches (< 30 min)
          LAST_DATA_CHANGE=$(git log -1 --format="%ct" -- data/)
          NOW=$(date +%s)
          DATA_AGE=$((NOW - LAST_DATA_CHANGE))
          if [ $DATA_AGE -gt 1800 ]; then
            echo "‚è≠ Pas de nouvelles donn√©es (dernier commit data/ il y a ${DATA_AGE}s)"
            SHOULD_RUN=false
          else
            echo "‚úÖ Donn√©es fra√Æches d√©tect√©es (${DATA_AGE}s)"
          fi

          # 2. V√©rifier que le briefing n'a pas d√©j√† √©t√© g√©n√©r√© r√©cemment (< 10h)
          if [ -f data/daily-briefing.json ] && git log -1 --format="%ct" -- data/daily-briefing.json > /dev/null 2>&1; then
            LAST_BRIEFING=$(git log -1 --format="%ct" -- data/daily-briefing.json)
            BRIEFING_AGE=$((NOW - LAST_BRIEFING))
            if [ $BRIEFING_AGE -lt 36000 ]; then
              echo "‚è≠ Briefing d√©j√† g√©n√©r√© il y a $((BRIEFING_AGE / 3600))h (< 10h) ‚Äî skip"
              SHOULD_RUN=false
            fi
          fi

          echo "data_changed=${SHOULD_RUN}" >> $GITHUB_OUTPUT

      - name: "üîÑ Cache mod√®le transformers.js"
        uses: actions/cache@v4
        with:
          path: .cache/transformers
          key: transformers-all-MiniLM-L6-v2

      - name: "üìö RAG ‚Äî Indexation des articles du jour"
        if: steps.check-data.outputs.data_changed == 'true'
        continue-on-error: true
        run: node scripts/rag-index.mjs --articles

      - name: "üß† G√©n√©ration du briefing strat√©gique (avec RAG)"
        if: steps.check-data.outputs.data_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/generate-daily-briefing.mjs

      - name: "üìã RAG ‚Äî Indexation du briefing produit"
        if: steps.check-data.outputs.data_changed == 'true'
        continue-on-error: true
        run: node scripts/rag-index.mjs --briefing

      - name: "‚è≠ G√©n√©ration ignor√©e ‚Äî donn√©es inchang√©es"
        if: steps.check-data.outputs.data_changed != 'true'
        run: echo "Les donn√©es n'ont pas chang√© depuis la derni√®re ex√©cution. Briefing ignor√©."

      - name: "üìù Commit et push"
        if: steps.check-data.outputs.data_changed == 'true'
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # Ajouter le briefing et les donn√©es RAG
          [ -f data/daily-briefing.json ] && git add data/daily-briefing.json || true
          [ -d data/rag ] && git add data/rag/ || true

          # V√©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "Aucun changement"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "üß† Briefing IA quotidien + RAG ‚Äî ${TIMESTAMP}

          Briefing strat√©gique g√©n√©r√© par Claude Sonnet (signaux + interconnexions + risk radar).
          Articles et briefing index√©s dans le store RAG."

          git push
