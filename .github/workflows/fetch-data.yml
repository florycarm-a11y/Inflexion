# Inflexion ‚Äî Workflow de r√©cup√©ration automatique des donn√©es
# Ex√©cut√© toutes les 6h + manuellement + √† chaque push sur main
#
# APIs (15 sources) :
#   - CoinGecko (crypto) ‚Üí sans cl√©
#   - Finnhub (march√©s, VIX) ‚Üí FINNHUB_API_KEY
#   - GNews (actualit√©s) ‚Üí GNEWS_API_KEY
#   - FRED (macro US, 10 s√©ries) ‚Üí FRED_API_KEY
#   - Alpha Vantage (forex, secteurs) ‚Üí ALPHA_VANTAGE_API_KEY
#   - Messari (crypto avanc√©) ‚Üí MESSARI_API_KEY
#   - Twelve Data (indices europ√©ens) ‚Üí TWELVE_DATA_API_KEY
#   - NewsAPI (news compl√©mentaires) ‚Üí NEWSAPI_API_KEY
#   - World Bank (macro internationale) ‚Üí sans cl√©
#   + Traduction EN‚ÜíFR (Claude Haiku) ‚Üí ANTHROPIC_API_KEY (optionnel)
#   - Alternative.me, DefiLlama, ECB, Mempool.space, metals.dev, Etherscan ‚Üí sans cl√©
#
# Flux RSS (97 sources sp√©cialis√©es, sans cl√©) :
#   üåç G√©opolitique (21) : France 24, BBC, Al Jazeera, Brookings, CFR, CSIS, Carnegie,
#     War on the Rocks, The Diplomat, Middle East Eye, Le Monde Intl...
#   üìà March√©s (25) : MarketWatch, Yahoo Finance, Wolf Street, Calculated Risk,
#     Le Monde √âco, Challenges, BIS, IMF Blog, WEF, PIIE, VoxEU, OECD...
#   ‚Çø Crypto (14) : Cryptoast, Journal du Coin, Blockworks, Unchained, Chainalysis...
#   ‚õèÔ∏è Commodit√©s (19) : OilPrice, Rigzone, Natural Gas Intel, MetalMiner, Mining.com,
#     IEA, IRENA, Carbon Brief, CleanTechnica, Energy Monitor...
#   ü§ñ IA & Tech (18) : TechCrunch, IEEE Spectrum, Krebs, BleepingComputer, The Register...
#
# R√©sultat : fichiers JSON dans /data/ committ√©s et d√©ploy√©s automatiquement

name: "üìä Fetch Market Data"

on:
  schedule:
    # Toutes les 6 heures (UTC) : 00h, 06h, 12h, 18h
    - cron: '0 0,6,12,18 * * *'

  # Ex√©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

  # Ex√©cuter aussi au push sur main (pour les premiers tests)
  push:
    branches: [main]
    paths:
      - 'scripts/fetch-data.mjs'
      - '.github/workflows/fetch-data.yml'

# Permissions n√©cessaires pour committer les fichiers JSON
permissions:
  contents: write

# Une seule ex√©cution √† la fois
concurrency:
  group: "fetch-data"
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "üì• Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "üü¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: "üì¶ Installation des d√©pendances"
        run: npm ci

      - name: "üìä R√©cup√©ration des donn√©es"
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          MESSARI_API_KEY: ${{ secrets.MESSARI_API_KEY }}
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API_KEY }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: node scripts/fetch-data.mjs

      - name: "üåê Traduction imm√©diate EN‚ÜíFR"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            node scripts/translate-articles.mjs
          else
            echo "‚ö† ANTHROPIC_API_KEY non d√©finie ‚Äî traduction diff√©r√©e"
          fi

      - name: "üìù Commit et push des donn√©es"
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # V√©rifier s'il y a des changements
          git add data/
          if git diff --staged --quiet; then
            echo "Aucun changement dans les donn√©es"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "üìä Donn√©es mises √† jour ‚Äî ${TIMESTAMP}

          Mise √† jour automatique des donn√©es march√©, crypto et actualit√©s.
          Prochaine mise √† jour dans ~6h."

          git push
