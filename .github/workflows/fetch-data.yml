# Inflexion ‚Äî Workflow de r√©cup√©ration automatique des donn√©es
# Ex√©cut√© toutes les 6h + manuellement + √† chaque push sur main
#
# APIs (15 sources) :
#   - CoinGecko (crypto) ‚Üí sans cl√©
#   - Finnhub (march√©s, VIX) ‚Üí FINNHUB_API_KEY
#   - GNews (actualit√©s) ‚Üí GNEWS_API_KEY
#   - FRED (macro US, 10 s√©ries) ‚Üí FRED_API_KEY
#   - Alpha Vantage (forex, secteurs) ‚Üí ALPHA_VANTAGE_API_KEY
#   - Messari (crypto avanc√©) ‚Üí MESSARI_API_KEY
#   - Twelve Data (indices europ√©ens) ‚Üí TWELVE_DATA_API_KEY
#   - NewsAPI (news compl√©mentaires) ‚Üí NEWSAPI_API_KEY
#   - World Bank (macro internationale) ‚Üí sans cl√©
#   + Traduction EN‚ÜíFR (Claude Haiku) ‚Üí ANTHROPIC_API_KEY (optionnel)
#   - Alternative.me, DefiLlama, ECB, Mempool.space, metals.dev, Etherscan ‚Üí sans cl√©
#
# Flux RSS (157 sources sp√©cialis√©es, sans cl√©) :
#   üåç G√©opolitique (21) : France 24, BBC, Al Jazeera, Brookings, CFR, CSIS, Carnegie...
#   üìà March√©s (25) : MarketWatch, Yahoo Finance, Wolf Street, BIS, IMF Blog, WEF, OECD...
#   ‚Çø Crypto (14) : Cryptoast, Journal du Coin, Blockworks, Unchained, Chainalysis...
#   ‚õèÔ∏è Commodit√©s (19) : OilPrice, Rigzone, MetalMiner, IEA, IRENA, Carbon Brief...
#   ü§ñ IA & Tech (18) : TechCrunch, IEEE Spectrum, Krebs, BleepingComputer, The Register...
#   üá™üá∫ Politique EU & Tech (18) : Bruegel, CEPS, ECFR, Euractiv, AlgorithmWatch, CNIL...
#   üõ°Ô∏è D√©fense & Strat√©gie (12) : RUSI, RAND, CNAS, Bellingcat, Defense One, Lawfare...
#   üåê Think tanks non-occidentaux (4) : ORF India, ISS Africa, ISEAS Singapore, NTI
#   + autres sources th√©matiques
#
# R√©sultat : fichiers JSON dans /data/ committ√©s et d√©ploy√©s automatiquement

name: "üìä Fetch Market Data"

on:
  schedule:
    # 2 fois par jour (UTC) : 06h et 18h
    - cron: '0 6,18 * * *'

  # Ex√©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

  # Ex√©cuter aussi au push sur main (pour les premiers tests)
  push:
    branches: [main]
    paths:
      - 'scripts/fetch-data.mjs'
      - '.github/workflows/fetch-data.yml'

# Permissions n√©cessaires pour committer les fichiers JSON
permissions:
  contents: write

# Une seule ex√©cution √† la fois
concurrency:
  group: "fetch-data"
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "üì• Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "üü¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: "üì¶ Installation des d√©pendances"
        run: npm ci

      - name: "üìä R√©cup√©ration des donn√©es"
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
          MESSARI_API_KEY: ${{ secrets.MESSARI_API_KEY }}
          TWELVE_DATA_API_KEY: ${{ secrets.TWELVE_DATA_API_KEY }}
          NEWSAPI_API_KEY: ${{ secrets.NEWSAPI_API_KEY }}
        run: node scripts/fetch-data.mjs

      # Traduction EN‚ÜíFR d√©plac√©e dans generate-article.yml (√©vite les doublons)

      - name: "üìù Commit et push des donn√©es"
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # V√©rifier s'il y a des changements
          git add data/
          if git diff --staged --quiet; then
            echo "Aucun changement dans les donn√©es"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "üìä Donn√©es mises √† jour ‚Äî ${TIMESTAMP}

          Mise √† jour automatique des donn√©es march√©, crypto et actualit√©s.
          Prochaine mise √† jour dans ~6h."

          git push

      - name: "üö® Alerte d'√©chec"
        if: failure()
        run: |
          echo "::error::Le workflow '${{ github.workflow }}' a √©chou√©!"
          echo "Branche: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # --- Webhook Discord (d√©commenter et ajouter DISCORD_WEBHOOK_URL dans les secrets) ---
          # curl -s -H "Content-Type: application/json" \
          #   -d "{\"content\": \"üö® **${{ github.workflow }}** a √©chou√© sur \`${{ github.ref_name }}\`\nCommit: ${{ github.sha }}\nLogs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
          #   "${{ secrets.DISCORD_WEBHOOK_URL }}"
          # --- Webhook Slack (d√©commenter et ajouter SLACK_WEBHOOK_URL dans les secrets) ---
          # curl -s -X POST -H "Content-Type: application/json" \
          #   -d "{\"text\": \"üö® *${{ github.workflow }}* a √©chou√© sur \`${{ github.ref_name }}\`\nCommit: ${{ github.sha }}\nLogs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
          #   "${{ secrets.SLACK_WEBHOOK_URL }}"
