# Inflexion â€” Workflow de rÃ©cupÃ©ration automatique des donnÃ©es
# ExÃ©cutÃ© toutes les 6h + manuellement + Ã  chaque push sur main
#
# APIs :
#   - CoinGecko (crypto) â†’ fonctionne sans clÃ©
#   - Finnhub (marchÃ©s) â†’ nÃ©cessite FINNHUB_API_KEY dans les secrets
#   - GNews (actualitÃ©s) â†’ nÃ©cessite GNEWS_API_KEY dans les secrets
#   - FRED (macro) â†’ nÃ©cessite FRED_API_KEY dans les secrets
#   - Alternative.me (Fear & Greed) â†’ fonctionne sans clÃ©
#
# RÃ©sultat : fichiers JSON dans /data/ committÃ©s et dÃ©ployÃ©s automatiquement

name: "ğŸ“Š Fetch Market Data"

on:
  schedule:
    # Toutes les 6 heures (UTC) : 00h, 06h, 12h, 18h
    - cron: '0 0,6,12,18 * * *'

  # ExÃ©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

  # ExÃ©cuter aussi au push sur main (pour les premiers tests)
  push:
    branches: [main]
    paths:
      - 'scripts/fetch-data.mjs'
      - '.github/workflows/fetch-data.yml'

# Permissions nÃ©cessaires pour committer les fichiers JSON
permissions:
  contents: write

# Une seule exÃ©cution Ã  la fois
concurrency:
  group: "fetch-data"
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "ğŸ“¥ Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "ğŸŸ¢ Setup Node.js 20"
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: "ğŸ“Š RÃ©cupÃ©ration des donnÃ©es"
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: node scripts/fetch-data.mjs

      - name: "ğŸ“ Commit et push des donnÃ©es"
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # VÃ©rifier s'il y a des changements
          git add data/
          if git diff --staged --quiet; then
            echo "Aucun changement dans les donnÃ©es"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ“Š DonnÃ©es mises Ã  jour â€” ${TIMESTAMP}

          Mise Ã  jour automatique des donnÃ©es marchÃ©, crypto et actualitÃ©s.
          Prochaine mise Ã  jour dans ~6h."

          git push
