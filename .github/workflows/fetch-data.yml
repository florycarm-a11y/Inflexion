# Inflexion â€” Workflow de rÃ©cupÃ©ration automatique des donnÃ©es
# ExÃ©cutÃ© toutes les 6h + manuellement + Ã  chaque push sur main
#
# APIs (11 sources) :
#   - CoinGecko (crypto) â†’ sans clÃ©
#   - Finnhub (marchÃ©s, VIX) â†’ FINNHUB_API_KEY
#   - GNews (actualitÃ©s) â†’ GNEWS_API_KEY
#   - FRED (macro US, 10 sÃ©ries) â†’ FRED_API_KEY
#   - Alpha Vantage (forex, secteurs) â†’ ALPHA_VANTAGE_API_KEY
#   - Alternative.me, DefiLlama, ECB, Mempool.space, metals.dev, Etherscan â†’ sans clÃ©
#
# Flux RSS (78 sources spÃ©cialisÃ©es, sans clÃ©) :
#   ğŸŒ GÃ©opolitique (20) : France 24, BBC, Al Jazeera, Brookings, CFR, CSIS, Carnegie,
#     War on the Rocks, The Diplomat, Middle East Eye...
#   ğŸ“ˆ MarchÃ©s (18) : MarketWatch, Yahoo Finance, Wolf Street, Calculated Risk...
#   â‚¿ Crypto (14) : Cryptoast, Journal du Coin, Blockworks, Unchained, Chainalysis...
#   â›ï¸ CommoditÃ©s (12) : OilPrice, Rigzone, Natural Gas Intel, MetalMiner, Mining.com...
#   ğŸ¤– IA & Tech (17) : TechCrunch, IEEE Spectrum, Krebs, BleepingComputer, The Register...
#
# RÃ©sultat : fichiers JSON dans /data/ committÃ©s et dÃ©ployÃ©s automatiquement

name: "ğŸ“Š Fetch Market Data"

on:
  schedule:
    # Toutes les 6 heures (UTC) : 00h, 06h, 12h, 18h
    - cron: '0 0,6,12,18 * * *'

  # ExÃ©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

  # ExÃ©cuter aussi au push sur main (pour les premiers tests)
  push:
    branches: [main]
    paths:
      - 'scripts/fetch-data.mjs'
      - '.github/workflows/fetch-data.yml'

# Permissions nÃ©cessaires pour committer les fichiers JSON
permissions:
  contents: write

# Une seule exÃ©cution Ã  la fois
concurrency:
  group: "fetch-data"
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "ğŸ“¥ Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "ğŸŸ¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: "ğŸ“¦ Installation des dÃ©pendances"
        run: npm ci

      - name: "ğŸ“Š RÃ©cupÃ©ration des donnÃ©es"
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        run: node scripts/fetch-data.mjs

      - name: "ğŸ“ Commit et push des donnÃ©es"
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # VÃ©rifier s'il y a des changements
          git add data/
          if git diff --staged --quiet; then
            echo "Aucun changement dans les donnÃ©es"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ğŸ“Š DonnÃ©es mises Ã  jour â€” ${TIMESTAMP}

          Mise Ã  jour automatique des donnÃ©es marchÃ©, crypto et actualitÃ©s.
          Prochaine mise Ã  jour dans ~6h."

          git push
