# Inflexion ‚Äî Workflow de r√©cup√©ration automatique des donn√©es
# Ex√©cut√© toutes les 6h + manuellement + √† chaque push sur main
#
# APIs :
#   - CoinGecko (crypto) ‚Üí fonctionne sans cl√©
#   - Finnhub (march√©s) ‚Üí n√©cessite FINNHUB_API_KEY dans les secrets
#   - GNews (actualit√©s) ‚Üí n√©cessite GNEWS_API_KEY dans les secrets
#   - FRED (macro) ‚Üí n√©cessite FRED_API_KEY dans les secrets
#
# R√©sultat : fichiers JSON dans /data/ committ√©s et d√©ploy√©s automatiquement

name: "üìä Fetch Market Data"

on:
  schedule:
    # Toutes les 6 heures (UTC) : 00h, 06h, 12h, 18h
    - cron: '0 0,6,12,18 * * *'

  # Ex√©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

  # Ex√©cuter aussi au push sur main (pour les premiers tests)
  push:
    branches: [main]
    paths:
      - 'scripts/fetch-data.mjs'
      - '.github/workflows/fetch-data.yml'

# Permissions n√©cessaires pour committer les fichiers JSON
permissions:
  contents: write

# Une seule ex√©cution √† la fois
concurrency:
  group: "fetch-data"
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "üì• Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "üü¢ Setup Node.js 20"
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: "üìä R√©cup√©ration des donn√©es"
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: node scripts/fetch-data.mjs

      - name: "üìù Commit et push des donn√©es"
        run: |
          git config user.name "Inflexion Bot"
          git config user.email "bot@inflexionhub.com"

          # V√©rifier s'il y a des changements
          git add data/
          if git diff --staged --quiet; then
            echo "Aucun changement dans les donn√©es"
            exit 0
          fi

          # Commit avec timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "üìä Donn√©es mises √† jour ‚Äî ${TIMESTAMP}

          Mise √† jour automatique des donn√©es march√©, crypto et actualit√©s.
          Prochaine mise √† jour dans ~6h."

          git push
