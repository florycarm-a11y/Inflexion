# Inflexion ‚Äî R√©daction IA quotidienne & Classification
# D√©clench√© automatiquement apr√®s le succ√®s de fetch-data (workflow_run)
#
# Pr√©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets (console.anthropic.com)
#   - TAVILY_API_KEY dans GitHub Secrets (app.tavily.com ‚Äî optionnel, enrichit les articles)
#   - PAT_TOKEN dans GitHub Secrets (pour cr√©er la PR)
#   - data/news.json doit exister (g√©n√©r√© par fetch-data.yml)

name: "‚úçÔ∏è Generate Daily Article"

on:
  # D√©clench√© automatiquement apr√®s fetch-data
  workflow_run:
    workflows: ["üìä Fetch Market Data"]
    types: [completed]

  # Ex√©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

# Permissions n√©cessaires pour cr√©er une PR
permissions:
  contents: write
  pull-requests: write

# Une seule ex√©cution √† la fois
concurrency:
  group: "generate-article"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Ne s'ex√©cuter que si fetch-data a r√©ussi (ou si d√©clench√© manuellement/push)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: "üì• Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "üü¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: "üì¶ Install dependencies"
        run: npm ci

      - name: "üîç V√©rifier la fra√Æcheur des donn√©es et l'absence de doublon"
        id: check-data
        run: |
          SHOULD_RUN=true

          # 1. V√©rifier que les donn√©es sont fra√Æches (< 30 min)
          LAST_DATA_CHANGE=$(git log -1 --format="%ct" -- data/)
          NOW=$(date +%s)
          DATA_AGE=$((NOW - LAST_DATA_CHANGE))
          if [ $DATA_AGE -gt 1800 ]; then
            echo "‚è≠ Pas de nouvelles donn√©es (dernier commit data/ il y a ${DATA_AGE}s)"
            SHOULD_RUN=false
          else
            echo "‚úÖ Donn√©es fra√Æches d√©tect√©es (${DATA_AGE}s)"
          fi

          # 2. V√©rifier que l'article n'a pas d√©j√† √©t√© g√©n√©r√© r√©cemment (< 10h)
          if [ -f data/article-du-jour.json ] && git log -1 --format="%ct" -- data/article-du-jour.json > /dev/null 2>&1; then
            LAST_ARTICLE=$(git log -1 --format="%ct" -- data/article-du-jour.json)
            ARTICLE_AGE=$((NOW - LAST_ARTICLE))
            if [ $ARTICLE_AGE -lt 36000 ]; then
              echo "‚è≠ Article d√©j√† g√©n√©r√© il y a $((ARTICLE_AGE / 3600))h (< 10h) ‚Äî skip"
              SHOULD_RUN=false
            fi
          fi

          echo "data_changed=${SHOULD_RUN}" >> $GITHUB_OUTPUT

      - name: "üåê Traduction des articles EN‚ÜíFR"
        if: steps.check-data.outputs.data_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/translate-articles.mjs

      - name: "‚úçÔ∏è G√©n√©ration article + classification"
        if: steps.check-data.outputs.data_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: node scripts/generate-article.mjs

      - name: "‚è≠ G√©n√©ration ignor√©e ‚Äî donn√©es inchang√©es"
        if: steps.check-data.outputs.data_changed != 'true'
        run: echo "Les donn√©es n'ont pas chang√© depuis la derni√®re ex√©cution. G√©n√©ration ignor√©e."

      - name: "üîÄ Cr√©er une PR pour relecture"
        if: steps.check-data.outputs.data_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: |
            ‚úçÔ∏è Article du jour ‚Äî ${{ github.run_id }}

            G√©n√©ration automatique de l'article de synth√®se et classification des news.
          title: "‚úçÔ∏è Article du jour ‚Äî ${{ github.run_id }}"
          body: |
            ## Contenu g√©n√©r√© par IA

            Ce PR contient l'article du jour et la classification des news, g√©n√©r√©s automatiquement par Claude.

            **Fichiers modifi√©s :**
            - `data/news.json` ‚Äî articles traduits et classifi√©s
            - `data/article-du-jour.json` ‚Äî article de synth√®se
            - `data/articles/` ‚Äî articles individuels

            > √Ä relire avant merge pour publication sur GitHub Pages.
          branch: ai/article-du-jour
          delete-branch: true
          add-paths: |
            data/news.json
            data/article-du-jour.json
            data/articles/
