# Inflexion â€” RÃ©daction IA quotidienne & Classification
# DÃ©clenchÃ© automatiquement aprÃ¨s le succÃ¨s de fetch-data (workflow_run)
#
# PrÃ©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets (console.anthropic.com)
#   - TAVILY_API_KEY dans GitHub Secrets (app.tavily.com â€” optionnel, enrichit les articles)
#   - PAT_TOKEN dans GitHub Secrets (pour crÃ©er la PR)
#   - data/news.json doit exister (gÃ©nÃ©rÃ© par fetch-data.yml)

name: "âœï¸ Generate Daily Article"

on:
  # DÃ©clenchÃ© automatiquement aprÃ¨s fetch-data
  workflow_run:
    workflows: ["ðŸ“Š Fetch Market Data"]
    types: [completed]

  # ExÃ©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

  # ExÃ©cuter aussi au push sur main (pour les premiers tests)
  push:
    branches: [main]
    paths:
      - 'scripts/generate-article.mjs'
      - '.github/workflows/generate-article.yml'

# Permissions nÃ©cessaires pour crÃ©er une PR
permissions:
  contents: write
  pull-requests: write

# Une seule exÃ©cution Ã  la fois
concurrency:
  group: "generate-article"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Ne s'exÃ©cuter que si fetch-data a rÃ©ussi (ou si dÃ©clenchÃ© manuellement/push)
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: "ðŸ“¥ Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "ðŸŸ¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: "ðŸ” VÃ©rifier la fraÃ®cheur des donnÃ©es"
        id: check-data
        run: |
          LAST_DATA_CHANGE=$(git log -1 --format="%ct" -- data/)
          NOW=$(date +%s)
          DIFF=$((NOW - LAST_DATA_CHANGE))
          if [ $DIFF -gt 1800 ]; then
            echo "data_changed=false" >> $GITHUB_OUTPUT
            echo "â­ Pas de nouvelles donnÃ©es (dernier commit data/ il y a ${DIFF}s)"
          else
            echo "data_changed=true" >> $GITHUB_OUTPUT
            echo "âœ… DonnÃ©es fraÃ®ches dÃ©tectÃ©es (${DIFF}s)"
          fi

      - name: "ðŸŒ Traduction des articles ENâ†’FR"
        if: steps.check-data.outputs.data_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/translate-articles.mjs

      - name: "âœï¸ GÃ©nÃ©ration article + classification"
        if: steps.check-data.outputs.data_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: node scripts/generate-article.mjs

      - name: "â­ GÃ©nÃ©ration ignorÃ©e â€” donnÃ©es inchangÃ©es"
        if: steps.check-data.outputs.data_changed != 'true'
        run: echo "Les donnÃ©es n'ont pas changÃ© depuis la derniÃ¨re exÃ©cution. GÃ©nÃ©ration ignorÃ©e."

      - name: "ðŸ”€ CrÃ©er une PR pour relecture"
        if: steps.check-data.outputs.data_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: |
            âœï¸ Article du jour â€” ${{ github.run_id }}

            GÃ©nÃ©ration automatique de l'article de synthÃ¨se et classification des news.
          title: "âœï¸ Article du jour â€” ${{ github.run_id }}"
          body: |
            ## Contenu gÃ©nÃ©rÃ© par IA

            Ce PR contient l'article du jour et la classification des news, gÃ©nÃ©rÃ©s automatiquement par Claude.

            **Fichiers modifiÃ©s :**
            - `data/news.json` â€” articles traduits et classifiÃ©s
            - `data/article-du-jour.json` â€” article de synthÃ¨se
            - `data/articles/` â€” articles individuels

            > Ã€ relire avant merge pour publication sur GitHub Pages.
          branch: ai/article-du-jour
          delete-branch: true
          add-paths: |
            data/news.json
            data/article-du-jour.json
            data/articles/
