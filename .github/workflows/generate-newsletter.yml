# Inflexion â€” Newsletter hebdomadaire
# ExÃ©cutÃ© chaque dimanche Ã  10h UTC
#
# PrÃ©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets
#   - PAT_TOKEN dans GitHub Secrets
#   - data/articles/ doit contenir les articles quotidiens de la semaine

name: "ðŸ“° Generate Weekly Newsletter"

on:
  schedule:
    # Chaque dimanche Ã  10h UTC
    - cron: '0 10 * * 0'

  # ExÃ©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

# Permissions nÃ©cessaires pour crÃ©er une PR
permissions:
  contents: write
  pull-requests: write

# Une seule exÃ©cution Ã  la fois
concurrency:
  group: "generate-newsletter"
  cancel-in-progress: true

jobs:
  newsletter:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "ðŸ“¥ Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "ðŸŸ¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: "ðŸ“° GÃ©nÃ©ration newsletter hebdomadaire"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/generate-newsletter.mjs

      - name: "ðŸ”€ CrÃ©er une PR pour relecture"
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: |
            ðŸ“° Newsletter hebdomadaire â€” ${{ github.run_id }}

            SynthÃ¨se automatique de la semaine via Claude.
          title: "ðŸ“° Newsletter hebdomadaire â€” ${{ github.run_id }}"
          body: |
            ## Newsletter gÃ©nÃ©rÃ©e par IA

            Ce PR contient la newsletter hebdomadaire, gÃ©nÃ©rÃ©e automatiquement par Claude.

            **Fichier modifiÃ© :**
            - `data/newsletter.json` â€” synthÃ¨se de la semaine

            > Ã€ relire avant merge pour publication sur GitHub Pages.
          branch: ai/newsletter-hebdo
          delete-branch: true
          add-paths: |
            data/newsletter.json
