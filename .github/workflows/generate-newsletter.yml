# Inflexion ‚Äî Newsletter hebdomadaire
# Ex√©cut√© chaque dimanche √† 10h UTC
#
# Pr√©requis :
#   - ANTHROPIC_API_KEY dans GitHub Secrets
#   - PAT_TOKEN dans GitHub Secrets
#   - data/articles/ doit contenir les articles quotidiens de la semaine

name: "üì∞ Generate Weekly Newsletter"

on:
  schedule:
    # Chaque dimanche √† 10h UTC
    - cron: '0 10 * * 0'

  # Ex√©cution manuelle depuis l'onglet Actions
  workflow_dispatch:

# Permissions n√©cessaires pour cr√©er une PR
permissions:
  contents: write
  pull-requests: write

# Une seule ex√©cution √† la fois
concurrency:
  group: "generate-newsletter"
  cancel-in-progress: true

jobs:
  newsletter:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "üì• Checkout du repo"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: "üü¢ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: "üì¶ Install dependencies"
        run: npm ci

      - name: "üîç V√©rifier l'absence de doublon"
        id: check-freshness
        run: |
          SHOULD_RUN=true
          NOW=$(date +%s)
          if [ -f data/newsletter.json ] && git log -1 --format="%ct" -- data/newsletter.json > /dev/null 2>&1; then
            LAST_NEWSLETTER=$(git log -1 --format="%ct" -- data/newsletter.json)
            NEWSLETTER_AGE=$((NOW - LAST_NEWSLETTER))
            # Skip si newsletter g√©n√©r√©e il y a moins de 6 jours (518400s)
            if [ $NEWSLETTER_AGE -lt 518400 ]; then
              echo "‚è≠ Newsletter d√©j√† g√©n√©r√©e il y a $((NEWSLETTER_AGE / 86400))j (< 6j) ‚Äî skip"
              SHOULD_RUN=false
            fi
          fi
          echo "should_run=${SHOULD_RUN}" >> $GITHUB_OUTPUT

      - name: "üì∞ G√©n√©ration newsletter hebdomadaire"
        if: steps.check-freshness.outputs.should_run == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: node scripts/generate-newsletter.mjs

      - name: "‚è≠ G√©n√©ration ignor√©e ‚Äî newsletter r√©cente"
        if: steps.check-freshness.outputs.should_run != 'true'
        run: echo "Newsletter d√©j√† g√©n√©r√©e r√©cemment. G√©n√©ration ignor√©e."

      - name: "üîÄ Cr√©er une PR pour relecture"
        if: steps.check-freshness.outputs.should_run == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: |
            üì∞ Newsletter hebdomadaire ‚Äî ${{ github.run_id }}

            Synth√®se automatique de la semaine via Claude.
          title: "üì∞ Newsletter hebdomadaire ‚Äî ${{ github.run_id }}"
          body: |
            ## Newsletter g√©n√©r√©e par IA

            Ce PR contient la newsletter hebdomadaire, g√©n√©r√©e automatiquement par Claude.

            **Fichier modifi√© :**
            - `data/newsletter.json` ‚Äî synth√®se de la semaine

            > √Ä relire avant merge pour publication sur GitHub Pages.
          branch: ai/newsletter-hebdo
          delete-branch: true
          add-paths: |
            data/newsletter.json
